name: ci-release-every-commit

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: write

jobs:
  build-test:
    name: Build + run (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Linux deps for building SFML from source via FetchContent + headless run with Xvfb [web:51]
      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build g++ git xvfb \
            libx11-dev libxrandr-dev libxcursor-dev libxi-dev libudev-dev \
            libgl1-mesa-dev libfreetype6-dev \
            libopenal-dev libvorbis-dev libflac-dev

      - name: Configure
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build -j 2

      # Smoke-run on Ubuntu: Xvfb + timeout, иначе GUI зависнет в CI [web:51]
      - name: Smoke run (Ubuntu) smile + elephant
        if: runner.os == 'Linux'
        run: |
          set -e
          test -f data/smile.txt
          test -f data/elephant.txt
          xvfb-run -a timeout 5s ./build/physics data/smile.txt || true
          xvfb-run -a timeout 5s ./build/physics data/elephant.txt || true

      # Smoke-run on Windows: стартуем процесс и убиваем через несколько секунд (GUI) [file:14]
      - name: Smoke run (Windows) smile + elephant
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (!(Test-Path "data\smile.txt")) { throw "data\smile.txt not found" }
          if (!(Test-Path "data\elephant.txt")) { throw "data\elephant.txt not found" }

          $p1 = Start-Process -FilePath ".\build\physics.exe" -ArgumentList "data\smile.txt" -PassThru
          Start-Sleep -Seconds 5
          if (!$p1.HasExited) { Stop-Process -Id $p1.Id -Force }

          $p2 = Start-Process -FilePath ".\build\physics.exe" -ArgumentList "data\elephant.txt" -PassThru
          Start-Sleep -Seconds 5
          if (!$p2.HasExited) { Stop-Process -Id $p2.Id -Force }

      # Packaging for release assets
      - name: Pack (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          tar -czf physics-linux.tar.gz -C build physics

      - name: Pack (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path build\physics.exe -DestinationPath physics-windows.zip -Force

      - name: Upload artifact (Linux)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: release-linux
          path: physics-linux.tar.gz

      - name: Upload artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          path: physics-windows.zip

  release:
    name: Tag + Release (each commit)
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: [build-test]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Create tag for this commit
        id: tag
        shell: bash
        run: |
          TAG="ci-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$TAG" "$GITHUB_SHA"
          git push origin "$TAG"

      # Create release for that tag; releases are tag-based in GitHub flow [web:85][web:41]
      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          prerelease: true
          files: |
            release-linux/physics-linux.tar.gz
            release-windows/physics-windows.zip
